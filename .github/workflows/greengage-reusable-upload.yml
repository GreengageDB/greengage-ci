# .github/workflows/greengage-reusable-upload.yml
name: Greengage Reusable Docker Retag and Upload Workflow

on:
  workflow_call:
    inputs:
      version:
        description: 'Version derived from tag (e.g., 6 or 7)'
        required: true
        type: string
      target_os:
        description: 'Target OS'
        required: true
        type: string
      target_os_version:
        description: 'Target OS version'
        required: false
        type: string
        default: ''
      python3:
        description: 'Python3 build argument'
        required: false
        type: string
        default: ''
    secrets:
      ghcr_token:
        description: 'GitHub token for GHCR access'
        required: true
      DOCKERHUB_USERNAME:
        description: 'DockerHub username for authentication'
        # required: true
        required: false
      DOCKERHUB_TOKEN:
        description: 'DockerHub token for authentication'
        # required: true
        required: false

jobs:
  upload:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Explicit for default behavior
      packages: write # Required to push to GHCR
    steps:
      # Login to GHCR is mandatory - failure will stop the workflow
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.ghcr_token }}

      # Login to DockerHub is conditional
      # For greengagedb/greengage: mandatory (failure will stop workflow)
      # For other repos: optional (failure is allowed)
      - name: Login to DockerHub
        id: dhcr_login
        continue-on-error: ${{ github.repository != 'greengagedb/greengage' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Maximize disk space
        uses: greengagedb/greengage-ci/.github/actions/maximize-disk-space@v19

      # Checkout default branch if no ref is specified
      - name: Checkout Greengage repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          submodules: recursive
          fetch-depth: 0  # Full history for tag resolution
          filter: blob:none # without BLOBs

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Fetch all tags
        run: git fetch --tags --force

      - name: Restore & Load SHA image
        uses: greengagedb/greengage-ci/.github/actions/restore-load-image@v19
        with:
          version: ${{ inputs.version }}
          target_os: ${{ inputs.target_os }}

      - name: Tag and push Docker image
        env:
          REF: ${{ github.ref }}
          IMAGE: ggdb${{ inputs.version }}_${{ inputs.target_os }}${{ inputs.target_os_version }}
          DHCR_LOGGED_IN: ${{ steps.dhcr_login.outcome == 'success' && 'true' || '' }}
        run: |
          GHCR_IMAGE=ghcr.io/${{ github.repository }}/${IMAGE}       ; export GHCR_IMAGE=${GHCR_IMAGE,,}
          DOCKERHUB_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/${IMAGE} ; export DOCKERHUB_IMAGE=${DOCKERHUB_IMAGE,,}

          # For tagged pushes, tag with git tag and check if it's the latest semantic tag
          if [[ "$REF" =~ ^refs/tags/ ]]; then
            # Current Git tag
            TAG=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/\//_/g' || echo "unknown")
            # All HEAD ref tags
            SEMANTIC_TAGS=$(git tag --merged | grep -E "^${{ inputs.version }}\.[0-9]+\.[0-9]+$" | sort -V)
            # Get the latest semantic tag
            LATEST_SEMANTIC_TAG=$(echo "$SEMANTIC_TAGS" | tail -n 1)
            # Check if the current tag is the latest semantic tag
            if [[ "$TAG" == "$LATEST_SEMANTIC_TAG" ]]; then
              LATEST='latest'
              echo "Current tag $TAG is the latest semantic tag"
            else
              LATEST=''
              echo "Current tag $TAG is not the latest semantic tag (latest is $LATEST_SEMANTIC_TAG)"
            fi
            [ -n "$DHCR_LOGGED_IN" ] && docker tag $GHCR_IMAGE:${{ github.sha }} $DOCKERHUB_IMAGE:$TAG && docker push $DOCKERHUB_IMAGE:$TAG || true
          else
            # For push to branch (e.g., main or 7.x) TAG is 'latest' for GHCR and 'testing' for DHCR
            LATEST='testing'
            # Update latest at GHCR for master pushes only
            docker tag $GHCR_IMAGE:${{ github.sha }} $GHCR_IMAGE:latest && docker push $GHCR_IMAGE:latest
          fi

          # If image was tagged
          [ -n "$TAG" ]    && docker tag $GHCR_IMAGE:${{ github.sha }} $GHCR_IMAGE:$TAG         && docker push $GHCR_IMAGE:$TAG

          # If tag is really latest or testing and DockerHub logged in
          [[ -n "$LATEST" && -n "$DHCR_LOGGED_IN" ]] && docker tag $GHCR_IMAGE:${{ github.sha }} $DOCKERHUB_IMAGE:$LATEST && docker push $DOCKERHUB_IMAGE:$LATEST || true
