name: Greengage Reusable Docker Retag and Upload Workflow

on:
  workflow_call:
    inputs:
      version:
        description: 'Version derived from tag (e.g., 6 or 7)'
        required: true
        type: string
      target_os:
        description: 'Target OS'
        required: true
        type: string
      target_os_version:
        description: 'Target OS version'
        required: false
        type: string
        default: ''
      python3:
        description: 'Python3 build argument'
        required: false
        type: string
        default: ''
    secrets:
      ghcr_token:
        description: 'GitHub token for GHCR access'
        required: true
      DOCKERHUB_USERNAME:
        description: 'DockerHub username for authentication'
        required: false
      DOCKERHUB_TOKEN:
        description: 'DockerHub token for authentication'
        required: false

jobs:
  upload:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Explicit for default behavior
      packages: write # Required to push to GHCR
    steps:
      # Login to GHCR is mandatory - failure will stop the workflow
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.ghcr_token }}

      # Login to DockerHub is conditional
      # For greengagedb/greengage: mandatory (failure will stop workflow)
      # For other repos: optional (failure is allowed)
      - name: Login to DockerHub
        id: dhcr_login
        continue-on-error: ${{ github.repository != 'greengagedb/greengage' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Move Docker storage to /mnt/docker
        run: |
          sudo bash -c '
            systemctl stop docker
            mkdir -p /mnt/docker
            rsync -a /var/lib/docker/ /mnt/docker
            chown -R docker:docker /mnt/docker
            echo "{ \"data-root\": \"/mnt/docker\" }" > /etc/docker/daemon.json
            systemctl start docker
          '

      # Checkout repository for tag resolution
      - name: Checkout Greengage repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          submodules: recursive
          fetch-depth: 0  # Full history for tag resolution
          filter: blob:none # without BLOBs

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Fetch all tags
        run: git fetch --tags --force

      - name: Restore & Load SHA image
        uses: greengagedb/greengage-ci/.github/actions/restore-load-image@main
        with:
          version: ${{ inputs.version }}
          target_os: ${{ inputs.target_os }}

      - name: Tag and push Docker image
        env:
          REF: ${{ github.ref }}
          IMAGE: ggdb${{ inputs.version }}_${{ inputs.target_os }}${{ inputs.target_os_version }}
          DHCR_LOGGED_IN: ${{ steps.dhcr_login.outcome == 'success' && 'true' || '' }}
        run: |
          GHCR_IMAGE=ghcr.io/${{ github.repository }}/${IMAGE}       ; export GHCR_IMAGE=${GHCR_IMAGE,,}
          DOCKERHUB_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/${IMAGE} ; export DOCKERHUB_IMAGE=${DOCKERHUB_IMAGE,,}

          echo "=== Docker Image Tagging and Push ==="
          echo "GHCR Image: $GHCR_IMAGE"
          echo "DockerHub Image: $DOCKERHUB_IMAGE"
          echo "DockerHub Login: $DHCR_LOGGED_IN"
          echo ""

          # Determine if this is a tag push or branch push
          if [[ "$REF" =~ ^refs/tags/ ]]; then
            # TAG PUSH: Get sanitized tag name
            IS_TAG_PUSH=true
            TAG=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/\//_/g' || echo "unknown")
            echo "ðŸ“Œ TAG PUSH detected: $TAG"
            
            # Check if this is the latest semantic tag
            SEMANTIC_TAGS=$(git tag --merged | grep -E "^${{ inputs.version }}\.[0-9]+\.[0-9]+$" | sort -V)
            LATEST_SEMANTIC_TAG=$(echo "$SEMANTIC_TAGS" | tail -n 1)
            
            if [[ "$TAG" == "$LATEST_SEMANTIC_TAG" ]]; then
              IS_LATEST_SEMANTIC=true
              echo "âœ“ This is the latest semantic tag for version ${{ inputs.version }}"
            else
              IS_LATEST_SEMANTIC=false
              echo "âœ— Not the latest semantic tag (latest is: $LATEST_SEMANTIC_TAG)"
            fi
          else
            # BRANCH PUSH
            IS_TAG_PUSH=false
            IS_LATEST_SEMANTIC=false
            echo "ðŸŒ¿ BRANCH PUSH detected: $REF"
          fi

          echo ""
          echo "=== Tagging and Pushing ==="
          
          # --- GHCR Operations (always mandatory) ---
          if [ "$IS_TAG_PUSH" = true ]; then
            # TAG PUSH to GHCR: push with tag name
            echo "â†’ GHCR: Tagging with $TAG"
            docker tag $GHCR_IMAGE:${{ github.sha }} $GHCR_IMAGE:$TAG
            echo "â†’ GHCR: Pushing $TAG"
            docker push $GHCR_IMAGE:$TAG
          else
            # BRANCH PUSH to GHCR: push with 'latest'
            echo "â†’ GHCR: Tagging with latest"
            docker tag $GHCR_IMAGE:${{ github.sha }} $GHCR_IMAGE:latest
            echo "â†’ GHCR: Pushing latest"
            docker push $GHCR_IMAGE:latest
          fi

          # --- DockerHub Operations (conditional based on login) ---
          if [ "$DHCR_LOGGED_IN" = "true" ]; then
            if [ "$IS_TAG_PUSH" = true ]; then
              # TAG PUSH to DockerHub: push with tag name
              echo "â†’ DockerHub: Tagging with $TAG"
              docker tag $GHCR_IMAGE:${{ github.sha }} $DOCKERHUB_IMAGE:$TAG
              echo "â†’ DockerHub: Pushing $TAG"
              docker push $DOCKERHUB_IMAGE:$TAG
              
              # If this is the latest semantic tag, also push as 'latest'
              if [ "$IS_LATEST_SEMANTIC" = true ]; then
                echo "â†’ DockerHub: Tagging with latest (latest semantic tag)"
                docker tag $GHCR_IMAGE:${{ github.sha }} $DOCKERHUB_IMAGE:latest
                echo "â†’ DockerHub: Pushing latest"
                docker push $DOCKERHUB_IMAGE:latest
              fi
            else
              # BRANCH PUSH to DockerHub: push with 'testing'
              echo "â†’ DockerHub: Tagging with testing"
              docker tag $GHCR_IMAGE:${{ github.sha }} $DOCKERHUB_IMAGE:testing
              echo "â†’ DockerHub: Pushing testing"
              docker push $DOCKERHUB_IMAGE:testing
            fi
          else
            echo "âŠ˜ DockerHub: Skipped (not logged in)"
          fi

          echo ""
          echo "=== Push completed successfully ==="
