# .github/actions/tests/regression/action.yml
name: "Regression Tests"
description: "Run regression tests with specified optimizer"

inputs:
  image:
    description: 'Greengage image for tests'
    required: true
  optimizer:
    description: 'Optimizer for tests (e.g., postgres, orca)'
    required: true
  target_os:
    description: 'Target OS for test (e.g., ubuntu, centos)'
    required: true
  target_os_version:
    description: 'Target OS version (e.g., 22.04)'
    required: false
    default: ''
  dump_db:
    description: 'Dump database after tests'
    required: false
    default: ''
  log_dir:
    description: 'Directory for logs mount in container'
    required: false
    default: '/mnt/logs'
  log_name:
    description: 'Container name for log collection'
    required: false
    default: 'ggdb_test'

runs:
  using: "composite"
  steps:
    - name: Regression Tests with optimizer '${{ inputs.optimizer }}'${{ inputs.dump_db && ' and DB dump'}}
      shell: bash
      env:
        CI: 'true'
        IMAGE: ${{ inputs.image }}
        TEST_OS: ${{ inputs.target_os }}
        DUMP_DB: ${{ inputs.dump_db }}
        MAKE_TEST_COMMAND: "-k PGOPTIONS='-c optimizer=${{ inputs.optimizer == 'orca' && 'on' || 'off' }}' installcheck-world"
        LOG_DIR:  ${{ inputs.log_dir  }}
        LOG_NAME: ${{ inputs.log_name }}

      run: |
        # Sanitize LOG_NAME - remove all except alphanumeric, underscore, hyphen
        LOG_NAME=$(echo "$LOG_NAME" | sed 's/[^a-zA-Z0-9_-]//g')
        if [ -z "$LOG_NAME" ]; then
          echo "::error::LOG_NAME is empty after sanitization"
          exit 1
        fi

        # Sanitize LOG_DIR - remove all except alphanumeric, slash, dot, hyphen, underscore
        LOG_DIR=$(echo "$LOG_DIR" | sed 's/[^a-zA-Z0-9_./-]//g')
        if [ -z "$LOG_DIR" ]; then
          echo "::error::LOG_DIR is empty after sanitization"
          exit 1
        fi

        docker run -i --name $LOG_NAME \
          -v $LOG_DIR:/logs \
          -e CI \
          -e TEST_OS \
          -e DUMP_DB \
          -e MAKE_TEST_COMMAND \
          --sysctl 'kernel.sem=500 1024000 200 4096' \
          ${IMAGE,,} \
          /bin/bash << 'END_OF_SCRIPT'
        set -x
        ssh-keygen -A
        /usr/sbin/sshd

        cd /home/gpadmin || exit 1

        exit_code=0
        bash gpdb_src/concourse/scripts/ic_gpdb.bash || exit_code=1
        echo "Script gpdb_src/concourse/scripts/ic_gpdb.bash finished with $exit_code"

        exit $exit_code
        END_OF_SCRIPT
