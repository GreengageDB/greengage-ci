# .github/actions/tests/regression/action.yml
name: "Regression Tests"
description: "Run regression tests with specified optimizer"

inputs:
  image:
    description: 'Greengage image for tests'
    required: true
  target_os:
    description: 'Target OS for test (e.g., ubuntu, centos)'
    required: true
  optimizer:
    description: 'Optimizer for tests (e.g., postgres, orca)'
    required: true
  log_dir:
    description: 'Output logs directory for mount in container'
    required: false
    default: '/mnt/logs'
  dump_db:
    description: 'Dump datatbase after tests'
    required: false
    default: ''

runs:
  using: "composite"
  steps:
    - name: Regression Tests for ${{ inputs.target_os }} with optimizer '${{ inputs.optimizer }}'${{ inputs.dump_db && ' and DB dump'}}
      shell: bash
      env:
        IMAGE: ${{ inputs.image }}
        TEST_OS: ${{ inputs.target_os }}
        DUMP_DB: ${{ inputs.dump_db }}
        MAKE_TEST_COMMAND: "-k PGOPTIONS='-c optimizer=${{ inputs.optimizer == 'orca' && 'on' || 'off' }}' installcheck-world"
        CI: 'true'

      run: |
        # Container name is passed from workflow via environment
        docker run -i --name $CONT_NAME \
          -v ${{ inputs.log_dir }}:/logs \
          -e CI \
          -e DUMP_DB \
          -e TEST_OS \
          -e MAKE_TEST_COMMAND \
          --sysctl 'kernel.sem=500 1024000 200 4096' \
          ${IMAGE,,} \
          /bin/bash << 'END_OF_SCRIPT'
        set -x
        ssh-keygen -A
        /usr/sbin/sshd

        cd /home/gpadmin || exit 1

        exit_code=0
        bash gpdb_src/concourse/scripts/ic_gpdb.bash || exit_code=1
        echo "Script gpdb_src/concourse/scripts/ic_gpdb.bash finished with $exit_code"

        exit $exit_code
        END_OF_SCRIPT
